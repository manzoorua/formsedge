import{s as e,Z as t,u as s,k as r,i,r as a,j as o,g as n,N as l,C as c,f as d,d as m,e as u,B as p}from"./main-BQOa5mM0.js";import{I as g}from"./input-COMLYb-C.js";import{B as f}from"./badge-6grXs2Vt.js";import{u as h}from"./useRecall-BxAtNLKx.js";import{F as b}from"./FieldRenderer-CugH2gNC.js";import{u as x,L as y}from"./useConditionalLogic-Domhckc1.js";import{C as j}from"./circle-check-big-BImW7D2D.js";import{S as v}from"./send-7VC4MSh_.js";import"./textarea-Dbo2TYJP.js";import"./label-B7su6Jaa.js";import"./checkbox-CljSm3_p.js";import"./index-Cff7j1dh.js";import"./check-WoqjMYuF.js";import"./radio-group-BjltNDB1.js";import"./index-_nftuPOU.js";import"./index-C38VFtOl.js";import"./circle-BfUTHkiN.js";import"./select-DDetsmr9.js";import"./index-CjuUx4b5.js";import"./chevron-down-BwC0H5jo.js";import"./separator-3yH5arB6.js";import"./index-CuckYF6g.js";import"./trash-2-B0C8EAKm.js";import"./star-Dd_cckZo.js";const _=()=>{const{id:_}=t(),{user:w}=s(),{toast:k}=r(),[N]=i(),C="1"===N.get("embed");N.get("mode");const S=N.get("theme")||"light",E=N.get("progress")||"top",F="true"===N.get("hideTitle"),I="true"===N.get("hideDescription"),[q,z]=a.useState(null),[P,O]=a.useState([]),[D,T]=a.useState({}),[R,G]=a.useState(!1),[$,W]=a.useState(!1),[Y,A]=a.useState(!0),[B,L]=a.useState({}),{triggerIntegrations:M}=(()=>{const t=async(e,t)=>{t.formId,t.responseId,t.submissionData,t.respondentEmail,t.urlParams,(new Date).toISOString(),e.name,e.integration_type};return{triggerIntegrations:async s=>{try{const{data:i,error:a}=await e.from("form_integrations").select("*").eq("form_id",s.formId).eq("is_active",!0);if(a)return;const o=i.filter(e=>"webhook"===e.integration_type||"n8n"===e.integration_type||"zapier"===e.integration_type),n=i.filter(e=>"webhook"!==e.integration_type&&"n8n"!==e.integration_type&&"zapier"!==e.integration_type);if(o.length>0)try{const{error:t}=await e.functions.invoke("webhook-dispatcher",{body:{formId:s.formId,responseId:s.responseId}})}catch(r){}const l=n.map(async r=>{try{await t(r,s),await e.from("form_integrations").update({last_triggered_at:(new Date).toISOString(),status:"connected",last_error:null}).eq("id",r.id)}catch(i){await e.from("form_integrations").update({status:"error",last_error:i instanceof Error?i.message:"Unknown error"}).eq("id",r.id)}});await Promise.allSettled(l)}catch(i){}}}})(),Z=a.useCallback((e,t)=>{C&&window.parent!==window&&window.parent.postMessage({source:"formsedge-widget",type:e,payload:{formId:_,...t}},"*")},[C,_]),{getVisibleFields:H}=x(P,D,!1),{resolveRecall:J}=h(P,D,B),K=a.useMemo(()=>{const e=q?.layout;return new y({columns:e?.columns||1,gridGap:e?.grid_gap||"md",responsive:e?.responsive??!0})},[q?.layout]),U=H;a.useEffect(()=>{},[P.length,U.length,D]),a.useEffect(()=>{_&&V()},[_]),a.useEffect(()=>{if(!q?.url_params_config)return;const e={};q.url_params_config.forEach(t=>{let s=null;t.default_value&&(s=t.default_value);const r=N.get(t.name);null!==r&&(s=r),null!==s&&(e[t.name]=s)}),L(e)},[q,N]),a.useEffect(()=>{C&&q&&Z("ready",{})},[C,q,Z,U.length]),a.useEffect(()=>{if(!C)return;const e=()=>{const e=document.documentElement.scrollHeight;Z("resize",{height:e})};e();const t=new ResizeObserver(e);return t.observe(document.body),()=>t.disconnect()},[C,Z,$,P]),a.useEffect(()=>{if(C&&"1"===N.get("debugInteraction")){const e=document.createElement("style");return e.textContent="body, #root { pointer-events: auto !important; }",document.head.appendChild(e),()=>e.remove()}},[C,N]);const V=async()=>{if(_){A(!0);try{const{data:t,error:s}=await e.from("forms").select("*").eq("id",_).eq("is_public",!0).eq("status","published").eq("accept_responses",!0).single();if(s)throw s;const{data:r,error:i}=await e.from("form_fields").select("*").eq("form_id",_).order("order_index");if(i)throw i;const a={...t,url_params_config:t.url_params_config||void 0,layout:"object"==typeof t.layout&&t.layout?t.layout:{columns:4,grid_gap:"md",responsive:!0},background:t.background||void 0};z(a),O(r.map(e=>({id:e.id,type:e.type,label:e.label,ref:e.ref,placeholder:e.placeholder,description:e.description,required:e.required,options:e.options,validation_rules:e.validation_rules,logic_conditions:e.logic_conditions,order_index:e.order_index,width:e.width,styling:e.styling,calculations:e.calculations,conditional_logic:e.conditional_logic})))}catch(t){k({title:"Form not found",description:"This form is not available or doesn't exist.",variant:"destructive"})}finally{A(!1)}}},X=(e,t)=>{T(s=>({...s,[e]:t}))},Q=async()=>{const t=(()=>{const e=[];return U.forEach(t=>{!t.required||D[t.id]&&""!==D[t.id]||e.push(`${t.label} is required`)}),e})();if(t.length>0)k({title:"Please fix the following errors:",description:t.join(", "),variant:"destructive"});else{G(!0);try{const{data:t,error:s}=await e.from("form_responses").insert({form_id:_,respondent_id:w?.id||null,respondent_email:q?.collect_emails?D.email:null,is_partial:!1,submitted_at:(new Date).toISOString(),url_params:Object.keys(B).length>0?B:null}).select().single();if(s)throw s;const r=U.filter(e=>void 0!==D[e.id]&&""!==D[e.id]).map(e=>({response_id:t.id,field_id:e.id,value:"string"==typeof D[e.id]?D[e.id]:JSON.stringify(D[e.id])}));if(r.length>0){const{error:t}=await e.from("form_response_answers").insert(r);if(t)throw t}if(await M({formId:_,responseId:t.id,submissionData:D,respondentEmail:q?.collect_emails?D.email:void 0,urlParams:Object.keys(B).length>0?B:void 0}),C&&Z("submit",{responseId:t.id}),q.redirect_url){const e=J(q.redirect_url);e&&(e.startsWith("http://")||e.startsWith("https://"))&&setTimeout(()=>{window.location.href=e},2e3)}W(!0),k({title:"Form submitted successfully!",description:"Thank you for your response."})}catch(s){k({title:"Error submitting form",description:s.message,variant:"destructive"})}finally{G(!1)}}};if(Y)return o.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-subtle",children:o.jsx(n,{className:"h-8 w-8 animate-spin text-primary"})});if(!q)return o.jsx(l,{to:"/404",replace:!0});if($){const e=o.jsx(c,{className:"w-full max-w-md text-center",children:o.jsxs(d,{className:"pt-6",children:[o.jsx(j,{className:"h-16 w-16 text-success mx-auto mb-4"}),o.jsx(m,{className:"mb-2",children:"Thank You!"}),o.jsx(u,{children:J(q.thank_you_message)||"Your form has been submitted successfully. We appreciate your response."})]})});return C?o.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",style:{background:"dark"===S?"#1a1a1a":"#ffffff"},children:e}):o.jsx("div",{className:"min-h-screen bg-gradient-subtle flex items-center justify-center p-4",children:e})}const ee=K.calculateFieldPositions(U),te=()=>{if(!q.background)return{};switch(q.background.type){case"color":return{backgroundColor:q.background.value};case"gradient":return{background:q.background.value};case"image":return{backgroundImage:`url(${q.background.value})`,backgroundSize:q.background.size||"cover",backgroundPosition:q.background.position||"center",backgroundRepeat:"no-repeat"};default:return{}}};if(C){const e=q.background?.type,t="dark"===S?"#1a1a1a":"#ffffff";return o.jsxs("div",{className:"min-h-screen relative",style:{fontFamily:q.font_family||"inherit",color:"dark"===S?"#ffffff":"#000000",padding:"2rem",...e?te():{background:t}},children:["image"===q.background?.type&&void 0!==q.background.opacity&&q.background.opacity>0&&o.jsx("div",{className:"absolute inset-0 bg-background pointer-events-none",style:{opacity:q.background.opacity/100}}),o.jsxs("div",{className:"max-w-4xl mx-auto relative z-10",children:[q.logo_url&&o.jsx("img",{src:q.logo_url,alt:"Form logo",className:"h-12 mb-4 object-contain"}),!F&&o.jsx("h1",{className:"text-3xl font-bold mb-4",style:{color:q.primary_color||"#3b82f6"},children:J(q.title)}),!I&&q.description&&o.jsx("p",{className:"text-lg mb-8 opacity-80",children:J(q.description)}),"none"!==E&&o.jsx("div",{className:"mb-6",children:o.jsx("div",{className:"h-1 bg-gray-200 rounded-full overflow-hidden",children:o.jsx("div",{className:"h-full transition-all duration-300",style:{width:"100%",backgroundColor:q.primary_color||"#3b82f6"}})})}),o.jsx("div",{className:`${K.getContainerClasses()} gap-6 mb-8`,children:ee.map(e=>{const t=U.find(t=>t.id===e.id);return t?o.jsx("div",{className:K.generateGridClasses(e),children:o.jsx(b,{field:{...t,label:J(t.label),description:J(t.description),placeholder:J(t.placeholder)},fields:U,formData:D,value:D[t.id]||"",onChange:e=>X(t.id,e),isPreview:!1})},t.id):null})}),q.collect_emails&&!w&&o.jsx(c,{className:"mb-6",children:o.jsx(d,{className:"pt-6",children:o.jsxs("div",{className:"space-y-3",children:[o.jsxs("label",{htmlFor:"email",className:"block text-sm font-medium",children:["Email Address ",o.jsx("span",{className:"text-destructive",children:"*"})]}),o.jsx(g,{id:"email",type:"email",value:D.email||"",onChange:e=>X("email",e.target.value),placeholder:"Enter your email address",required:!0})]})})}),o.jsx("div",{className:"text-center",children:o.jsx(p,{onClick:Q,disabled:R,className:"px-8 py-4 text-lg",size:"lg",style:{backgroundColor:q.primary_color||"#3b82f6"},children:R?o.jsxs(o.Fragment,{children:[o.jsx(n,{className:"mr-2 h-5 w-5 animate-spin"}),"Submitting..."]}):o.jsxs(o.Fragment,{children:[o.jsx(v,{className:"mr-2 h-5 w-5"}),"Submit Form"]})})})]})]})}return o.jsxs("div",{className:"min-h-screen py-8 relative",style:{fontFamily:q.font_family||"inherit",...te()},children:[!q.background?.type&&o.jsx("div",{className:"absolute inset-0 bg-gradient-subtle -z-10"}),"image"===q.background?.type&&void 0!==q.background.opacity&&q.background.opacity>0&&o.jsx("div",{className:"absolute inset-0 bg-background pointer-events-none",style:{opacity:q.background.opacity/100}}),o.jsxs("div",{className:"container mx-auto px-4 max-w-4xl relative z-10",children:[o.jsxs("div",{className:"mb-8 text-center",children:[q.logo_url&&o.jsx("img",{src:q.logo_url,alt:"Form logo",className:"h-16 mb-6 object-contain mx-auto"}),o.jsx("div",{className:"flex items-center justify-center mb-4",children:o.jsx(f,{variant:"outline",children:"Public Form"})}),o.jsx("h1",{className:"text-4xl font-bold mb-4",style:{color:q.primary_color||"#3b82f6"},children:J(q.title)}),q.description&&o.jsx("p",{className:"text-lg text-muted-foreground mb-6 max-w-2xl mx-auto",children:J(q.description)})]}),o.jsx("div",{className:`${K.getContainerClasses()} gap-6 mb-8`,children:ee.map(e=>{const t=U.find(t=>t.id===e.id);return t?o.jsx("div",{className:K.generateGridClasses(e),children:o.jsx(b,{field:{...t,label:J(t.label),description:J(t.description),placeholder:J(t.placeholder)},fields:U,formData:D,value:D[t.id]||"",onChange:e=>X(t.id,e),isPreview:!1})},t.id):null})}),q.collect_emails&&!w&&o.jsx(c,{className:"mb-6",children:o.jsx(d,{className:"pt-6",children:o.jsxs("div",{className:"space-y-3",children:[o.jsxs("label",{htmlFor:"email",className:"block text-sm font-medium",children:["Email Address ",o.jsx("span",{className:"text-destructive",children:"*"})]}),o.jsx(g,{id:"email",type:"email",value:D.email||"",onChange:e=>X("email",e.target.value),placeholder:"Enter your email address",required:!0})]})})}),o.jsx("div",{className:"text-center",children:o.jsx(p,{onClick:Q,disabled:R,className:"px-8 py-4 text-lg shadow-primary",size:"lg",style:{backgroundColor:q.primary_color||"#3b82f6"},children:R?o.jsxs(o.Fragment,{children:[o.jsx(n,{className:"mr-2 h-5 w-5 animate-spin"}),"Submitting..."]}):o.jsxs(o.Fragment,{children:[o.jsx(v,{className:"mr-2 h-5 w-5"}),"Submit Form"]})})}),o.jsxs("div",{className:"text-center mt-12 text-sm text-muted-foreground",children:["Powered by ",o.jsx("span",{className:"font-semibold text-primary",children:"FormsEdge"})]})]})]})};export{_ as default};
