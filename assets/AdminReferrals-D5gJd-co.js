import{c as e,r as s,k as t,s as a,j as r,g as i,B as n,C as l,b as c,d,e as o,f as u,A as m,T as h,q as x}from"./main-BQOa5mM0.js";import{B as j}from"./badge-6grXs2Vt.js";import{T as _,a as f,b as g,c as p,d as y,e as v}from"./table-CsUrjkkT.js";import{A as w,a as k,b as N,c as b}from"./accordion-DaF0Bt_M.js";import{I as S}from"./input-COMLYb-C.js";import{L as $}from"./label-B7su6Jaa.js";import{S as C}from"./switch-CocPZzzC.js";import{T as D,a as q,b as F,c as M}from"./tabs-BbGbqsLR.js";import{E as A}from"./eye-Bq8mO4No.js";import{S as E}from"./save-BPJYkrST.js";import{R}from"./rotate-ccw-C5cbz5Ew.js";import{H as P}from"./history-Jb2UQDc7.js";import{S as U}from"./settings-CSYLqhyU.js";import{C as O}from"./calendar-BcqkHMaS.js";import{D as I}from"./dollar-sign-CFY7m5M8.js";import{f as L}from"./format-CNqjFxb7.js";import"./index-CuckYF6g.js";import"./index-C38VFtOl.js";import"./chevron-down-BwC0H5jo.js";import"./index-Cff7j1dh.js";import"./index-_nftuPOU.js";import"./en-US-DcoqlHup.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=e("Percent",[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]]),J=()=>{const[e,w]=s.useState([]),[k,N]=s.useState([]),[b,J]=s.useState({}),[V,z]=s.useState(!0),[B,Q]=s.useState(!1),[T,W]=s.useState([]),[Z,G]=s.useState(!1),{toast:K}=t();s.useEffect(()=>{X(),Y()},[]);const X=async()=>{try{z(!0);const{data:e,error:s}=await a.from("referral_settings").select("*").eq("is_active",!0).order("setting_key");if(s)throw s;w(e||[]);const t={};e?.forEach(e=>{t[e.setting_key]=e.setting_value}),J(t)}catch(e){K({title:"Error",description:"Failed to fetch referral settings",variant:"destructive"})}finally{z(!1)}},Y=async()=>{try{const{data:e,error:s}=await a.from("admin_audit_log").select("*").eq("target_table","referral_settings").order("created_at",{ascending:!1}).limit(20);if(s)throw s;N(e||[])}catch(e){}},ee=(e,s,t)=>{J(a=>({...a,[e]:{...a[e],[s]:t}})),W(s=>s.filter(s=>s.field!==e))},se=e=>T.find(s=>s.field===e),te=e=>{switch(e){case"referral_bonus_amount":case"maximum_earning_per_referral":return r.jsx(I,{className:"h-4 w-4"});case"friend_discount_percentage":return r.jsx(H,{className:"h-4 w-4"});case"payment_schedule_days":case"payment_processing_frequency":return r.jsx(O,{className:"h-4 w-4"});default:return r.jsx(U,{className:"h-4 w-4"})}},ae=e=>{const s=b[e.setting_key]||e.setting_value;switch(e.setting_key){case"referral_bonus_amount":case"maximum_earning_per_referral":return r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsx($,{htmlFor:`${e.setting_key}_value`,children:"Amount ($)"}),r.jsx(S,{id:`${e.setting_key}_value`,type:"number",min:"0",max:"10000",step:"0.01",value:s?.value||0,onChange:s=>ee(e.setting_key,"value",parseFloat(s.target.value)||0),className:se(e.setting_key)?"border-destructive":""})]}),r.jsxs("div",{children:[r.jsx($,{htmlFor:`${e.setting_key}_currency`,children:"Currency"}),r.jsx(S,{id:`${e.setting_key}_currency`,value:s?.currency||"USD",onChange:s=>ee(e.setting_key,"currency",s.target.value),readOnly:!0})]})]});case"friend_discount_percentage":return r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsx($,{htmlFor:`${e.setting_key}_value`,children:"Percentage (%)"}),r.jsx(S,{id:`${e.setting_key}_value`,type:"number",min:"0",max:"100",step:"1",value:s?.value||0,onChange:s=>ee(e.setting_key,"value",parseInt(s.target.value)||0),className:se(e.setting_key)?"border-destructive":""})]}),r.jsxs("div",{children:[r.jsx($,{htmlFor:`${e.setting_key}_max_discount`,children:"Max Discount ($)"}),r.jsx(S,{id:`${e.setting_key}_max_discount`,type:"number",min:"0",step:"0.01",value:s?.max_discount||0,onChange:s=>ee(e.setting_key,"max_discount",parseFloat(s.target.value)||0)})]})]});case"payment_schedule_days":return r.jsxs("div",{children:[r.jsx($,{htmlFor:`${e.setting_key}_value`,children:"Schedule"}),r.jsxs("select",{id:`${e.setting_key}_value`,value:s?.value||"monthly",onChange:s=>ee(e.setting_key,"value",s.target.value),className:"w-full px-3 py-2 border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring",children:[r.jsx("option",{value:"weekly",children:"Weekly"}),r.jsx("option",{value:"monthly",children:"Monthly"}),r.jsx("option",{value:"quarterly",children:"Quarterly"})]})]});case"payment_processing_frequency":return r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsx($,{htmlFor:`${e.setting_key}_value`,children:"Frequency"}),r.jsxs("select",{id:`${e.setting_key}_value`,value:s?.value||"monthly",onChange:s=>ee(e.setting_key,"value",s.target.value),className:"w-full px-3 py-2 border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring",children:[r.jsx("option",{value:"weekly",children:"Weekly"}),r.jsx("option",{value:"monthly",children:"Monthly"}),r.jsx("option",{value:"quarterly",children:"Quarterly"})]})]}),r.jsxs("div",{children:[r.jsx($,{htmlFor:`${e.setting_key}_day_of_month`,children:"Day of Month"}),r.jsx(S,{id:`${e.setting_key}_day_of_month`,type:"number",min:"1",max:"31",value:s?.day_of_month||1,onChange:s=>ee(e.setting_key,"day_of_month",parseInt(s.target.value)||1)})]})]});case"referral_program_enabled":return r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(C,{id:`${e.setting_key}_enabled`,checked:s?.enabled||!1,onCheckedChange:s=>ee(e.setting_key,"enabled",s)}),r.jsx($,{htmlFor:`${e.setting_key}_enabled`,children:s?.enabled?"Enabled":"Disabled"})]});default:return r.jsxs("div",{children:[r.jsx($,{children:"Value (JSON)"}),r.jsx("pre",{className:"p-2 bg-muted rounded text-sm",children:JSON.stringify(s,null,2)})]})}};return V?r.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:r.jsx(i,{className:"h-8 w-8 animate-spin"})}):r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:"Referral Settings"}),r.jsx("p",{className:"text-muted-foreground",children:"Manage your referral program configuration"})]}),r.jsx("div",{className:"flex items-center gap-2",children:r.jsxs(n,{variant:"outline",onClick:()=>G(!Z),className:"flex items-center gap-2",children:[r.jsx(A,{className:"h-4 w-4"}),Z?"Edit Mode":"Preview Mode"]})})]}),r.jsxs(D,{defaultValue:"settings",className:"space-y-4",children:[r.jsxs(q,{children:[r.jsx(F,{value:"settings",children:"Settings"}),r.jsx(F,{value:"audit",children:"Audit Log"})]}),r.jsxs(M,{value:"settings",className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsxs(n,{onClick:async()=>{try{Q(!0);const e=(()=>{const e=[],s=b.referral_bonus_amount?.value;s&&(s<0||s>1e3)&&e.push({field:"referral_bonus_amount",message:"Bonus amount must be between $0 and $1000"});const t=b.friend_discount_percentage?.value;t&&(t<0||t>100)&&e.push({field:"friend_discount_percentage",message:"Discount percentage must be between 0% and 100%"});const a=b.maximum_earning_per_referral?.value;a&&(a<0||a>1e4)&&e.push({field:"maximum_earning_per_referral",message:"Maximum earning must be between $0 and $10,000"});const r=b.payment_schedule_days?.value;return r&&!["weekly","monthly","quarterly"].includes(r)&&e.push({field:"payment_schedule_days",message:"Payment schedule must be weekly, monthly, or quarterly"}),e})();if(W(e),e.length>0)return void K({title:"Validation Error",description:"Please fix the validation errors before saving",variant:"destructive"});const s=Object.entries(b).map(([e,s])=>({setting_key:e,setting_value:s,updated_at:(new Date).toISOString()}));for(const t of s){const{error:e}=await a.from("referral_settings").update({setting_value:t.setting_value,updated_at:t.updated_at}).eq("setting_key",t.setting_key);if(e)throw e}await X(),await Y(),K({title:"Success",description:"All settings updated successfully"})}catch(e){K({title:"Error",description:"Failed to save settings",variant:"destructive"})}finally{Q(!1)}},disabled:B,className:"flex items-center gap-2",children:[B?r.jsx(i,{className:"h-4 w-4 animate-spin"}):r.jsx(E,{className:"h-4 w-4"}),"Save All Changes"]}),r.jsxs(n,{variant:"outline",onClick:()=>{const s={};e.forEach(e=>{s[e.setting_key]=e.setting_value}),J(s),W([]),K({title:"Reset",description:"Settings reset to saved values"})},disabled:B,className:"flex items-center gap-2",children:[r.jsx(R,{className:"h-4 w-4"}),"Reset"]}),T.length>0&&r.jsxs(j,{variant:"destructive",children:[T.length," validation error",T.length>1?"s":""]})]}),r.jsx("div",{className:"grid gap-6 md:grid-cols-2",children:e.map(e=>{const s=se(e.setting_key);return r.jsxs(l,{className:"relative "+(s?"border-destructive":""),children:[r.jsxs(c,{children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs(d,{className:"text-lg flex items-center gap-2",children:[te(e.setting_key),e.setting_key.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())]}),r.jsx(j,{variant:e.is_active?"default":"secondary",children:e.is_active?"Active":"Inactive"})]}),r.jsx(o,{children:e.description})]}),r.jsxs(u,{className:"space-y-4",children:[s&&r.jsxs(m,{variant:"destructive",children:[r.jsx(h,{className:"h-4 w-4"}),r.jsx(x,{children:s.message})]}),ae(e),r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("span",{className:"text-sm text-muted-foreground",children:["Last updated: ",L(new Date(e.updated_at),"MMM dd, yyyy HH:mm")]}),r.jsxs(n,{variant:"outline",size:"sm",onClick:()=>(async(e,t)=>{try{Q(!0);const{error:s}=await a.from("referral_settings").update({setting_value:t,updated_at:(new Date).toISOString()}).eq("setting_key",e);if(s)throw s;await X(),await Y(),K({title:"Success",description:`${e} updated successfully`})}catch(s){K({title:"Error",description:`Failed to update ${e}`,variant:"destructive"})}finally{Q(!1)}})(e.setting_key,b[e.setting_key]),disabled:B,children:[r.jsx(E,{className:"mr-2 h-4 w-4"}),"Save"]})]})]})]},e.id)})})]}),r.jsx(M,{value:"audit",className:"space-y-4",children:r.jsxs(l,{children:[r.jsxs(c,{children:[r.jsxs(d,{className:"flex items-center gap-2",children:[r.jsx(P,{className:"h-5 w-5"}),"Recent Changes"]}),r.jsx(o,{children:"Audit trail of referral settings modifications"})]}),r.jsx(u,{children:r.jsxs(_,{children:[r.jsx(f,{children:r.jsxs(g,{children:[r.jsx(p,{children:"Action"}),r.jsx(p,{children:"Setting"}),r.jsx(p,{children:"Old Value"}),r.jsx(p,{children:"New Value"}),r.jsx(p,{children:"Date"})]})}),r.jsxs(y,{children:[k.map(e=>r.jsxs(g,{children:[r.jsx(v,{children:r.jsx(j,{variant:"outline",children:e.action})}),r.jsx(v,{children:e.new_values?.setting_key||"-"}),r.jsx(v,{className:"max-w-xs truncate",children:e.old_values?.setting_value?JSON.stringify(e.old_values.setting_value).substring(0,50)+"...":"-"}),r.jsx(v,{className:"max-w-xs truncate",children:e.new_values?.setting_value?JSON.stringify(e.new_values.setting_value).substring(0,50)+"...":"-"}),r.jsx(v,{children:L(new Date(e.created_at),"MMM dd, HH:mm")})]},e.id)),0===k.length&&r.jsx(g,{children:r.jsx(v,{colSpan:5,className:"text-center text-muted-foreground",children:"No audit logs found"})})]})]})})]})})]})]})};function V(){const[e,i]=s.useState([]),[c,o]=s.useState([]),[m,h]=s.useState([]),[x,S]=s.useState(!0),{toast:$}=t(),C=async()=>{try{const{data:e,error:s}=await a.from("referral_codes").select("id, code, user_id, current_uses, max_uses, is_active, created_at").order("created_at",{ascending:!1});if(s)throw s;const t=await Promise.all((e||[]).map(async e=>{const{data:s}=await a.from("profiles").select("email, first_name, last_name").eq("id",e.user_id).single();return{...e,profiles:s||void 0}}));i(t)}catch(e){}},D=async()=>{try{const{data:e,error:s}=await a.from("referrals").select("id, referrer_id, referred_id, status, reward_earned, created_at").order("created_at",{ascending:!1});if(s)throw s;const t=await Promise.all((e||[]).map(async e=>{const[s,t]=await Promise.all([a.from("profiles").select("email, first_name, last_name").eq("id",e.referrer_id).single(),a.from("profiles").select("email, first_name, last_name").eq("id",e.referred_id).single()]);return{...e,referrer_profile:s.data||void 0,referred_profile:t.data||void 0}}));o(t)}catch(e){}},q=async()=>{try{const{data:e,error:s}=await a.from("referral_rewards").select("id, user_id, amount, status, created_at, paid_at").order("created_at",{ascending:!1});if(s)throw s;const t=await Promise.all((e||[]).map(async e=>{const{data:s}=await a.from("profiles").select("email, first_name, last_name").eq("id",e.user_id).single();return{...e,profiles:s||void 0}}));h(t)}catch(e){}};return s.useEffect(()=>{(async()=>{S(!0),await Promise.all([C(),D(),q()]),S(!1)})()},[]),x?r.jsx("div",{className:"min-h-screen flex items-center justify-center",children:r.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-primary"})}):r.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:"Referral System"}),r.jsx("p",{className:"text-muted-foreground",children:"Manage referral codes, tracking, and rewards"})]}),r.jsx(J,{}),r.jsxs(w,{type:"multiple",className:"space-y-4",children:[r.jsxs(k,{value:"codes",children:[r.jsx(N,{children:r.jsxs(d,{children:["Referral Codes (",e.length,")"]})}),r.jsx(b,{children:r.jsx(l,{children:r.jsx(u,{className:"pt-6",children:r.jsxs(_,{children:[r.jsx(f,{children:r.jsxs(g,{children:[r.jsx(p,{children:"Code"}),r.jsx(p,{children:"User"}),r.jsx(p,{children:"Uses"}),r.jsx(p,{children:"Status"}),r.jsx(p,{children:"Created"}),r.jsx(p,{children:"Actions"})]})}),r.jsx(y,{children:e.map(e=>r.jsxs(g,{children:[r.jsx(v,{className:"font-mono",children:e.code}),r.jsx(v,{children:e.profiles?.email||"Unknown"}),r.jsxs(v,{children:[e.current_uses," / ",e.max_uses||"âˆž"]}),r.jsx(v,{children:r.jsx(j,{variant:e.is_active?"default":"secondary",children:e.is_active?"Active":"Inactive"})}),r.jsx(v,{children:new Date(e.created_at).toLocaleDateString()}),r.jsx(v,{children:r.jsx(n,{size:"sm",variant:"outline",onClick:()=>(async(e,s)=>{try{const{error:t}=await a.from("referral_codes").update({is_active:!s}).eq("id",e);if(t)throw t;$({title:"Success",description:`Referral code ${s?"deactivated":"activated"} successfully`}),C()}catch(t){$({title:"Error",description:"Failed to update referral code status",variant:"destructive"})}})(e.id,e.is_active),children:e.is_active?"Deactivate":"Activate"})})]},e.id))})]})})})})]}),r.jsxs(k,{value:"referrals",children:[r.jsx(N,{children:r.jsxs(d,{children:["Referrals (",c.length,")"]})}),r.jsx(b,{children:r.jsx(l,{children:r.jsx(u,{className:"pt-6",children:r.jsxs(_,{children:[r.jsx(f,{children:r.jsxs(g,{children:[r.jsx(p,{children:"Referrer"}),r.jsx(p,{children:"Referred"}),r.jsx(p,{children:"Status"}),r.jsx(p,{children:"Reward"}),r.jsx(p,{children:"Date"})]})}),r.jsx(y,{children:c.map(e=>r.jsxs(g,{children:[r.jsx(v,{children:e.referrer_profile?.email||"Unknown"}),r.jsx(v,{children:e.referred_profile?.email||"Unknown"}),r.jsx(v,{children:r.jsx(j,{variant:"completed"===e.status?"default":"secondary",children:e.status})}),r.jsxs(v,{children:["$",e.reward_earned]}),r.jsx(v,{children:new Date(e.created_at).toLocaleDateString()})]},e.id))})]})})})})]}),r.jsxs(k,{value:"rewards",children:[r.jsx(N,{children:r.jsxs(d,{children:["Rewards (",m.length,")"]})}),r.jsx(b,{children:r.jsx(l,{children:r.jsx(u,{className:"pt-6",children:r.jsxs(_,{children:[r.jsx(f,{children:r.jsxs(g,{children:[r.jsx(p,{children:"User"}),r.jsx(p,{children:"Amount"}),r.jsx(p,{children:"Status"}),r.jsx(p,{children:"Created"}),r.jsx(p,{children:"Paid"}),r.jsx(p,{children:"Actions"})]})}),r.jsx(y,{children:m.map(e=>r.jsxs(g,{children:[r.jsx(v,{children:e.profiles?.email||"Unknown"}),r.jsxs(v,{children:["$",e.amount]}),r.jsx(v,{children:r.jsx(j,{variant:"paid"===e.status?"default":"secondary",children:e.status})}),r.jsx(v,{children:new Date(e.created_at).toLocaleDateString()}),r.jsx(v,{children:e.paid_at?new Date(e.paid_at).toLocaleDateString():"-"}),r.jsx(v,{children:"pending"===e.status&&r.jsx(n,{size:"sm",variant:"outline",onClick:()=>(async e=>{try{const{error:s}=await a.from("referral_rewards").update({status:"paid",paid_at:(new Date).toISOString()}).eq("id",e);if(s)throw s;$({title:"Success",description:"Reward marked as paid successfully"}),q()}catch(s){$({title:"Error",description:"Failed to mark reward as paid",variant:"destructive"})}})(e.id),children:"Mark as Paid"})})]},e.id))})]})})})})]})]})]})}export{V as default};
