import{c as e,r as s,k as t,s as a,j as r,B as i,Y as n,g as o,Z as l,a as c,u as d,C as m,b as h,d as x,e as p,f as u}from"./main-BQOa5mM0.js";import{B as j}from"./badge-6grXs2Vt.js";import{D as f,f as g,a as v,b as w,c as y,e as b}from"./dialog-Zbmvpzx0.js";import{I as N}from"./input-COMLYb-C.js";import{L as k}from"./label-B7su6Jaa.js";import{S as _}from"./switch-CocPZzzC.js";import{v as S}from"./webhookValidation-DOL01rhp.js";import{S as C}from"./scroll-area-C89FDXlH.js";import{A as U,a as F,b as I,c as T}from"./accordion-DaF0Bt_M.js";import{S as E,a as A,b as M,c as z,d as q}from"./select-DDetsmr9.js";import{F as R}from"./file-text-WxvKYvjS.js";import{C as D}from"./copy-BZksGIXa.js";import{E as O}from"./external-link-IfMGOG27.js";import{C as L}from"./circle-alert-C_kZuZo4.js";import{C as W}from"./clock-BGkZXTj0.js";import{C as $}from"./circle-x-BCWjiaKg.js";import{C as P}from"./circle-check-big-BImW7D2D.js";import{f as V}from"./format-CNqjFxb7.js";import{A as H}from"./arrow-left-BoD24ioV.js";import{W as B}from"./webhook-CO3AmyxJ.js";import{Z}from"./zap-Ewtv7hwb.js";import{M as J}from"./mail-BKZIg2ud.js";import{M as G}from"./message-square-DQzNuabs.js";import{S as Q}from"./settings-CSYLqhyU.js";import{T as K}from"./trash-2-B0C8EAKm.js";import{P as X}from"./plus-Bqj9WNI1.js";import"./index-D4HqgO5_.js";import"./index-CjuUx4b5.js";import"./index-Cff7j1dh.js";import"./index-C38VFtOl.js";import"./index-CuckYF6g.js";import"./chevron-down-BwC0H5jo.js";import"./check-WoqjMYuF.js";import"./en-US-DcoqlHup.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=e("FileSpreadsheet",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M8 13h2",key:"yr2amv"}],["path",{d:"M14 13h2",key:"un5t4a"}],["path",{d:"M8 17h2",key:"2yhykz"}],["path",{d:"M14 17h2",key:"10kma7"}]]),ee=({integrationId:e,integrationName:l})=>{const[c,d]=s.useState(!1),[m,h]=s.useState([]),[x,p]=s.useState(!1),[u,N]=s.useState("all"),[k,_]=s.useState(null),{toast:S}=t();s.useEffect(()=>{c&&H()},[c,e]);const H=async()=>{p(!0);try{let s=a.from("webhook_delivery_logs").select("*").eq("integration_id",e).order("created_at",{ascending:!1}).limit(100);"all"!==u&&(s=s.eq("status",u));const{data:t,error:r}=await s;if(r)throw r;h(t||[])}catch(s){S({title:"Error loading logs",description:s.message,variant:"destructive"})}finally{p(!1)}},B=e=>{switch(e){case"success":return r.jsx(P,{className:"h-4 w-4 text-success"});case"failed":return r.jsx($,{className:"h-4 w-4 text-destructive"});case"pending":return r.jsx(W,{className:"h-4 w-4 text-warning"});case"retrying":return r.jsx(n,{className:"h-4 w-4 text-primary animate-spin"});default:return r.jsx(L,{className:"h-4 w-4 text-muted-foreground"})}},Z=e=>e?e>=200&&e<300?"text-success":e>=400&&e<500?"text-warning":e>=500?"text-destructive":"text-muted-foreground":"text-muted-foreground";return r.jsxs(f,{open:c,onOpenChange:d,children:[r.jsx(g,{asChild:!0,children:r.jsxs(i,{variant:"ghost",size:"sm",children:[r.jsx(R,{className:"h-3 w-3 mr-1"}),"View Logs"]})}),r.jsxs(v,{className:"max-w-4xl max-h-[90vh]",children:[r.jsxs(w,{children:[r.jsx(y,{children:"Webhook Delivery Logs"}),r.jsxs(b,{children:[l," - Recent webhook deliveries"]})]}),r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(E,{value:u,onValueChange:N,children:[r.jsx(A,{className:"w-[180px]",children:r.jsx(M,{placeholder:"Filter by status"})}),r.jsxs(z,{children:[r.jsx(q,{value:"all",children:"All Status"}),r.jsx(q,{value:"success",children:"Success"}),r.jsx(q,{value:"failed",children:"Failed"}),r.jsx(q,{value:"pending",children:"Pending"}),r.jsx(q,{value:"retrying",children:"Retrying"})]})]}),r.jsxs(i,{onClick:H,variant:"outline",size:"sm",disabled:x,children:[r.jsx(n,{className:"h-4 w-4 mr-2 "+(x?"animate-spin":"")}),"Refresh"]})]}),r.jsxs("div",{className:"text-sm text-muted-foreground",children:[m.length," ",1===m.length?"log":"logs"]})]}),r.jsx(C,{className:"h-[500px] pr-4",children:x?r.jsx("div",{className:"flex items-center justify-center py-12",children:r.jsx(o,{className:"h-8 w-8 animate-spin text-primary"})}):0===m.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(R,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),r.jsx("p",{className:"text-muted-foreground",children:"No webhook logs found"}),r.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"all"!==u?"Try changing the filter":"Logs will appear here after form submissions"})]}):r.jsx(U,{type:"single",collapsible:!0,className:"space-y-2",children:m.map(e=>{return r.jsxs(F,{value:e.id,className:"border rounded-lg px-4",children:[r.jsx(I,{className:"hover:no-underline",children:r.jsx("div",{className:"flex items-center justify-between w-full pr-4",children:r.jsxs("div",{className:"flex items-center gap-3",children:[B(e.status),r.jsxs("div",{className:"text-left",children:[r.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[(s=e.status,r.jsx(j,{variant:{success:"default",failed:"destructive",pending:"secondary",retrying:"outline"}[s]||"secondary",children:s})),r.jsx("span",{className:`text-sm font-mono ${Z(e.http_status)}`,children:e.http_status||"N/A"}),e.attempt>1&&r.jsxs(j,{variant:"outline",className:"text-xs",children:["Attempt ",e.attempt]})]}),r.jsx("div",{className:"text-xs text-muted-foreground",children:V(new Date(e.created_at),"MMM d, yyyy HH:mm:ss")})]})]})})}),r.jsx(T,{children:r.jsxs("div",{className:"space-y-4 pt-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-sm font-medium",children:"Event ID:"}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("code",{className:"text-xs bg-muted px-2 py-1 rounded",children:e.event_id}),r.jsx(i,{variant:"ghost",size:"sm",onClick:()=>{return s=e.event_id,navigator.clipboard.writeText(s),void S({title:"Copied",description:"Event ID copied to clipboard"});var s},children:r.jsx(D,{className:"h-3 w-3"})})]})]}),r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-sm font-medium",children:"URL:"}),r.jsxs("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-primary hover:underline flex items-center gap-1",children:[e.url.substring(0,50),"...",r.jsx(O,{className:"h-3 w-3"})]})]}),e.error_message&&r.jsxs("div",{className:"bg-destructive/10 border border-destructive/20 rounded p-3",children:[r.jsx("span",{className:"text-sm font-medium text-destructive",children:"Error:"}),r.jsx("p",{className:"text-sm text-destructive mt-1",children:e.error_message})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("span",{className:"text-sm font-medium",children:"Request Body:"}),r.jsx("pre",{className:"text-xs bg-muted p-3 rounded overflow-auto max-h-40",children:JSON.stringify(e.request_body,null,2)})]}),e.response_body&&r.jsxs("div",{className:"space-y-2",children:[r.jsx("span",{className:"text-sm font-medium",children:"Response Body:"}),r.jsx("pre",{className:"text-xs bg-muted p-3 rounded overflow-auto max-h-40",children:e.response_body})]}),"failed"===e.status&&e.response_id&&r.jsx("div",{className:"flex justify-end pt-2",children:r.jsx(i,{variant:"outline",size:"sm",onClick:()=>(async e=>{if(e.response_id){_(e.id);try{const{error:s}=await a.functions.invoke("webhook-dispatcher",{body:{formId:e.form_id,responseId:e.response_id}});if(s)throw s;S({title:"Webhook retried",description:"The webhook has been queued for retry"}),setTimeout(H,2e3)}catch(s){S({title:"Retry failed",description:s.message,variant:"destructive"})}finally{_(null)}}else S({title:"Cannot retry",description:"This webhook has no associated response ID",variant:"destructive"})})(e),disabled:k===e.id,children:k===e.id?r.jsxs(r.Fragment,{children:[r.jsx(o,{className:"h-3 w-3 mr-2 animate-spin"}),"Retrying..."]}):r.jsxs(r.Fragment,{children:[r.jsx(n,{className:"h-3 w-3 mr-2"}),"Retry Webhook"]})})})]})})]},e.id);var s})})})]})]})},se=[{type:"webhook",name:"Webhook",description:"Send form data to any HTTP endpoint",icon:B,color:"bg-blue-500"},{type:"n8n",name:"n8n",description:"Connect to n8n workflows for advanced automation",icon:Z,color:"bg-purple-500"},{type:"email",name:"Email Notifications",description:"Send email notifications on form submissions",icon:J,color:"bg-green-500"},{type:"zapier",name:"Zapier",description:"Connect to 3000+ apps via Zapier webhooks",icon:Z,color:"bg-orange-500"},{type:"sheets",name:"Google Sheets",description:"Save responses directly to Google Sheets",icon:Y,color:"bg-emerald-500"},{type:"slack",name:"Slack",description:"Get notified in Slack channels",icon:G,color:"bg-violet-500"}],te=()=>{const{id:e}=l(),n=c(),{toast:g}=t(),{user:C}=d(),[U,F]=s.useState(null),[I,T]=s.useState([]),[E,A]=s.useState(!0),[M,z]=s.useState(null),[q,R]=s.useState(null),[D,O]=s.useState(!1),[W,V]=s.useState(!1),[B,J]=s.useState(!1),[G,Y]=s.useState(null),[te,ae]=s.useState({name:"",webhookUrl:"",secret:"",isActive:!0});s.useEffect(()=>{e&&C&&re()},[e,C]);const re=async()=>{try{const[s,t]=await Promise.all([a.from("forms").select("id, title, owner_id").eq("id",e).single(),a.from("form_integrations").select("*").eq("form_id",e)]);if(s.error)throw s.error;if(t.error)throw t.error;F(s.data),T(t.data)}catch(s){g({title:"Error",description:"Failed to load form integrations",variant:"destructive"})}finally{A(!1)}},ie=e=>{switch(e){case"connected":return r.jsx(P,{className:"h-4 w-4 text-success"});case"error":return r.jsx($,{className:"h-4 w-4 text-destructive"});case"testing":return r.jsx(L,{className:"h-4 w-4 text-warning"});default:return r.jsx($,{className:"h-4 w-4 text-muted-foreground"})}};return E?r.jsx("div",{className:"container mx-auto px-4 py-8",children:r.jsxs("div",{className:"animate-pulse space-y-4",children:[r.jsx("div",{className:"h-8 bg-muted rounded w-1/4"}),r.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[1,2,3,4,5,6].map(e=>r.jsx("div",{className:"h-32 bg-muted rounded"},e))})]})}):U?r.jsxs("div",{className:"container mx-auto px-4 py-8",children:[r.jsxs("div",{className:"mb-8",children:[r.jsxs(i,{variant:"ghost",onClick:()=>n("/dashboard"),className:"mb-4",children:[r.jsx(H,{className:"h-4 w-4 mr-2"}),"Back to Dashboard"]}),r.jsx("div",{className:"flex items-center justify-between",children:r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold text-foreground",children:U.title}),r.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage integrations for this form"})]})})]}),I.length>0&&r.jsxs("div",{className:"mb-8",children:[r.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Connected Integrations"}),r.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:I.map(e=>{const s=se.find(s=>s.type===e.integration_type),t=s?.icon||Q;return r.jsxs(m,{className:"relative",children:[r.jsx(h,{className:"pb-3",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("div",{className:`p-2 rounded-md ${s?.color||"bg-muted"}`,children:r.jsx(t,{className:"h-4 w-4 text-white"})}),r.jsxs("div",{children:[r.jsx(x,{className:"text-sm",children:e.name}),r.jsx(p,{className:"text-xs",children:s?.description||e.integration_type})]})]}),ie(e.status)]})}),r.jsxs(u,{className:"pt-0",children:[r.jsx("div",{className:"flex items-center justify-between mb-2",children:(n=e.status,r.jsx(j,{variant:{connected:"default",disconnected:"secondary",error:"destructive",testing:"outline"}[n]||"secondary",children:n.charAt(0).toUpperCase()+n.slice(1)}))}),r.jsxs("div",{className:"flex items-center gap-2",children:[("webhook"===e.integration_type||"n8n"===e.integration_type||"zapier"===e.integration_type)&&r.jsx(ee,{integrationId:e.id,integrationName:e.name}),r.jsxs(i,{variant:"outline",size:"sm",onClick:()=>(e=>{const s=se.find(s=>s.type===e.integration_type);z(s),R(e),ae({name:e.name,webhookUrl:e.configuration?.webhook_url||e.configuration?.url||"",secret:e.configuration?.secret||"",isActive:e.is_active}),Y(null),O(!0)})(e),children:[r.jsx(Q,{className:"h-3 w-3 mr-1"}),"Configure"]}),r.jsx(i,{variant:"ghost",size:"sm",onClick:()=>(async(e,s)=>{if(confirm(`Are you sure you want to delete "${s}"? This action cannot be undone.`))try{const{error:t}=await a.from("form_integrations").delete().eq("id",e);if(t)throw t;g({title:"Integration deleted",description:`${s} has been removed`}),await re()}catch(t){g({title:"Error",description:t.message||"Failed to delete integration",variant:"destructive"})}})(e.id,e.name),className:"text-destructive hover:text-destructive",children:r.jsx(K,{className:"h-3 w-3"})})]}),e.last_error&&r.jsx("p",{className:"text-xs text-destructive mt-2",children:e.last_error})]})]},e.id);var n})})]}),r.jsxs("div",{children:[r.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Available Integrations"}),r.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:se.map(e=>{const s=e.icon,t=(a=e.type,I.some(e=>e.integration_type===a&&e.is_active));var a;return r.jsxs(m,{className:"hover:shadow-md transition-shadow",children:[r.jsx(h,{className:"pb-3",children:r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx("div",{className:`p-2 rounded-md ${e.color}`,children:r.jsx(s,{className:"h-5 w-5 text-white"})}),r.jsxs("div",{className:"flex-1",children:[r.jsx(x,{className:"text-base",children:e.name}),r.jsx(p,{className:"text-sm",children:e.description})]})]})}),r.jsx(u,{className:"pt-0",children:r.jsx(i,{onClick:()=>(e=>{const s=se.find(s=>s.type===e);z(s),R(null),ae({name:`My ${s?.name} Integration`,webhookUrl:"",secret:"",isActive:!0}),Y(null),O(!0)})(e.type),variant:t?"outline":"default",className:"w-full",children:t?r.jsxs(r.Fragment,{children:[r.jsx(Q,{className:"h-4 w-4 mr-2"}),"Add Another"]}):r.jsxs(r.Fragment,{children:[r.jsx(X,{className:"h-4 w-4 mr-2"}),"Connect"]})})})]},e.type)})})]}),r.jsx(f,{open:D,onOpenChange:O,children:r.jsxs(v,{className:"sm:max-w-[500px]",children:[r.jsxs(w,{children:[r.jsxs(y,{children:[q?"Edit":"Configure"," ",M?.name]}),r.jsx(b,{children:M?.description})]}),r.jsxs("div",{className:"space-y-4 py-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(k,{htmlFor:"name",children:"Integration Name"}),r.jsx(N,{id:"name",value:te.name,onChange:e=>ae(s=>({...s,name:e.target.value})),placeholder:`My ${M?.name} Integration`})]}),("webhook"===M?.type||"n8n"===M?.type||"zapier"===M?.type)&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(k,{htmlFor:"webhook-url",children:"n8n"===M.type?"n8n Webhook URL":"Webhook URL"}),r.jsx(N,{id:"webhook-url",value:te.webhookUrl,onChange:e=>ae(s=>({...s,webhookUrl:e.target.value})),placeholder:"https://your-endpoint.com/webhook",type:"url"}),"n8n"===M.type&&r.jsx("p",{className:"text-sm text-muted-foreground",children:"Create a webhook trigger in your n8n workflow and paste the URL here."})]}),"webhook"===M?.type&&r.jsxs("div",{className:"space-y-2",children:[r.jsx(k,{htmlFor:"webhook-secret",children:"Webhook Secret (Optional)"}),r.jsx(N,{id:"webhook-secret",value:te.secret,onChange:e=>ae(s=>({...s,secret:e.target.value})),placeholder:"Leave empty for no signature verification",type:"password"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Used to generate HMAC signature in X-FormsEdge-Signature header"})]}),r.jsx(i,{onClick:async()=>{J(!0),Y(null);try{if(!te.webhookUrl.trim())throw new Error("Please enter a webhook URL");const{isValid:s,error:t}=S(te.webhookUrl);if(!s)throw new Error(t);const a={event_id:crypto.randomUUID(),event_type:"form_response",created_at:(new Date).toISOString(),form_response:{id:"sample-response-id",form_id:e,form_title:U?.title||"Test Form",status:"complete",respondent_id:null,respondent_email:"test@example.com",created_at:(new Date).toISOString(),submitted_at:(new Date).toISOString(),url_params:{utm_source:"test"},metadata:{completion_time_seconds:120,completion_time_label:"2 minutes"},answers:[{field:{id:"sample-field-id",label:"Sample Question",type:"text"},type:"text",value:"Sample answer for testing"}]}},r=await fetch(te.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":"FormsEdge-Webhook-Test/1.0"},body:JSON.stringify(a)}),i=await r.text();Y({success:r.ok,message:r.ok?`Success! Webhook endpoint returned HTTP ${r.status}`:`Failed with HTTP ${r.status}`,details:{status:r.status,statusText:r.statusText,body:i}})}catch(s){Y({success:!1,message:s.message||"Test failed",details:s})}finally{J(!1)}},disabled:B,variant:"outline",size:"sm",className:"w-full",children:B?r.jsxs(r.Fragment,{children:[r.jsx(o,{className:"h-4 w-4 mr-2 animate-spin"}),"Testing..."]}):r.jsxs(r.Fragment,{children:[r.jsx(Z,{className:"h-4 w-4 mr-2"}),"Test Webhook"]})}),G&&r.jsxs("div",{className:"p-3 rounded-md "+(G.success?"bg-success/10 text-success":"bg-destructive/10 text-destructive"),children:[r.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[G.success?r.jsx(P,{className:"h-4 w-4"}):r.jsx($,{className:"h-4 w-4"}),r.jsx("span",{className:"font-medium",children:G.message})]}),G.details&&r.jsxs("details",{className:"text-xs mt-2",children:[r.jsx("summary",{className:"cursor-pointer",children:"View details"}),r.jsx("pre",{className:"mt-2 p-2 bg-background/50 rounded overflow-auto",children:JSON.stringify(G.details,null,2)})]})]})]}),r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(_,{id:"active",checked:te.isActive,onCheckedChange:e=>ae(s=>({...s,isActive:e}))}),r.jsx(k,{htmlFor:"active",children:"Enable this integration"})]})]}),r.jsxs("div",{className:"flex justify-end space-x-2",children:[r.jsx(i,{variant:"outline",onClick:()=>O(!1),children:"Cancel"}),r.jsx(i,{onClick:async()=>{if(e&&C&&M){V(!0);try{if(!te.name.trim())throw new Error("Integration name is required");if("webhook"===M.type||"n8n"===M.type||"zapier"===M.type){if(!te.webhookUrl.trim())throw new Error("Webhook URL is required");const{isValid:e,error:s}=S(te.webhookUrl);if(!e)throw new Error(s)}const s={};if("webhook"===M.type?(s.webhook_url=te.webhookUrl,s.url=te.webhookUrl,te.secret&&(s.secret=te.secret)):"n8n"!==M.type&&"zapier"!==M.type||(s.webhook_url=te.webhookUrl,s.url=te.webhookUrl),q){const{error:e}=await a.from("form_integrations").update({name:te.name,configuration:s,is_active:te.isActive,updated_at:(new Date).toISOString()}).eq("id",q.id);if(e)throw e;g({title:"Integration updated",description:`${te.name} has been updated successfully`})}else{const{error:t}=await a.from("form_integrations").insert({form_id:e,integration_type:M.type,name:te.name,configuration:s,is_active:te.isActive,status:"connected",created_by:C.id});if(t)throw t;g({title:"Integration connected",description:`${te.name} has been connected successfully`})}await re(),O(!1)}catch(s){g({title:"Error",description:s.message||"Failed to save integration",variant:"destructive"})}finally{V(!1)}}},disabled:W,children:W?r.jsxs(r.Fragment,{children:[r.jsx(o,{className:"h-4 w-4 mr-2 animate-spin"}),"Saving..."]}):"Save Integration"})]})]})})]}):r.jsx("div",{className:"container mx-auto px-4 py-8",children:r.jsxs("div",{className:"text-center",children:[r.jsx("h1",{className:"text-2xl font-bold text-foreground mb-4",children:"Form not found"}),r.jsxs(i,{onClick:()=>n("/dashboard"),children:[r.jsx(H,{className:"h-4 w-4 mr-2"}),"Back to Dashboard"]})]})})};export{te as default};
